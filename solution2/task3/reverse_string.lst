     1                                  ; Задача №2.1. Разворот входящей строки
     2                                  
     3                                  ; Объявление констант
     4                                  %define MAX_INPUT_STR_SIZE 100  ; максимальный размер входной строки 100 символов
     5                                  
     6                                  %define EXIT 60                 ; 60 - номер системного вызова exit
     7                                  %define READ 0                  ; 0 - номер системного вызова read
     8                                  %define WRITE 1                 ; 1 - номер системного вызова write
     9                                  
    10                                  %define STDIN 0                 ; 0 - дескриптор стандартного ввода
    11                                  %define STDOUT 1                ; 1 - дескриптор стандартного вывода
    12                                  %define STDERR 2                ; 2 - дескриптор стандартного потока ошибок
    13                                  
    14                                  %define NULL_CHAR 0             ; код символа '\0'
    15                                  %define NEWLINE 0x0A            ; код символа перевода строки '\n'
    16                                  
    17                                  global _start   ; делаем точку входа _start видимой для линковщика
    18                                  
    19                                  section .bss    ; Секция BSS — для глобальных неинициализированных переменных
    20 00000000 <res 64h>                   input_str resb MAX_INPUT_STR_SIZE               ; буфер для ввода строки
    21 00000064 <res 64h>                   reverse_str resb MAX_INPUT_STR_SIZE             ; буфер для развернутой строки
    22                                  
    23                                  section .data                                       ; секция данных
    24                                      ; Подсказки в консоли
    25 00000000 456E74657220796F75-         prompt1 db "Enter your string: ", NULL_CHAR     ; подсказка для ввода строки
    25 00000009 7220737472696E673A-
    25 00000012 2000               
    26                                      len_prompt1 equ $-prompt1                       ; длина подсказки 1
    27                                  
    28 00000014 52657665727365643A-         msg_result db "Reversed: ", NULL_CHAR           ; подсказка для вывода перевернутой строки
    28 0000001D 2000               
    29                                      len_msg_result equ $-msg_result                 ; длина подсказки результата
    30                                  
    31                                      ; Сообщения об ошибках
    32 0000001F 4572726F723A207772-         write_failed_msg db "Error: write() failed", NEWLINE, NULL_CHAR                                     ; сообщение об ошибке write
    32 00000028 697465282920666169-
    32 00000031 6C65640A00         
    33                                      write_failed_msg_len equ $ - write_failed_msg                                                       ; длина сообщения
    34 00000036 4572726F723A207772-         write_byte_number_mismatch_msg db "Error: write() write wrong number of bytes", NEWLINE, NULL_CHAR  ; ошибка записи неправильного количества байт
    34 0000003F 697465282920777269-
    34 00000048 74652077726F6E6720-
    34 00000051 6E756D626572206F66-
    34 0000005A 2062797465730A00   
    35                                      write_byte_number_mismatch_msg_len equ $ - write_byte_number_mismatch_msg                           ; длина сообщения
    36                                  
    37 00000062 4572726F723A207265-         read_failed_msg db "Error: read() failed", NEWLINE, NULL_CHAR                                       ; сообщение об ошибке read
    37 0000006B 61642829206661696C-
    37 00000074 65640A00           
    38                                      read_failed_msg_len equ $ - read_failed_msg                                                         ; длина сообщения
    39                                  
    40                                  section .text
    41                                  
    42                                  _start:     ; точка входа программы
    43 00000000 4D31ED                      xor r13, r13                            ; устанавливаем код завершения r13 = 0 (успех)
    44                                  
    45                                      ; ---- Промпт 1 ----
    46 00000003 B801000000                  mov rax, WRITE
    47 00000008 BF01000000                  mov rdi, STDOUT
    48 0000000D 488D35(00000000)            lea rsi, [rel prompt1]
    49 00000014 BA14000000                  mov rdx, len_prompt1
    50 00000019 0F05                        syscall
    51                                  
    52 0000001B 4885C0                      test rax, rax                           ; проверка возвращенного значения rax (кол-во записанных байт)
    53 0000001E 0F88E4000000                js write_failed_handler                 ; если rax < 0 (ошибка), прыжок к обработчику ошибки записи
    54                                  
    55 00000024 4839D0                      cmp rax, rdx                            ; проверяем, совпадает ли количество записанных байт с ожидаемым
    56 00000027 0F85FB000000                jne write_byte_number_mismatch_handler  ; если нет, прыжок к обработчику несоответствия байт
    57                                  
    58                                      ; Чтение строки с клавиатуры
    59 0000002D B800000000                  mov rax, READ                           ; номер системного вызова read
    60 00000032 BF00000000                  mov rdi, STDIN                          ; дескриптор входного потока (stdin)
    61 00000037 48BE-                       mov rsi, input_str                      ; адрес буфера для сохранения введенной строки
    61 00000039 [0000000000000000] 
    62 00000041 BA64000000                  mov rdx, MAX_INPUT_STR_SIZE             ; количество байтов для чтения
    63 00000046 0F05                        syscall                                 ; выполнить системный вызов read
    64                                  
    65 00000048 4885C0                      test rax, rax                           ; проверяем возвращенное значение rax (кол-во прочитанных байт)
    66 0000004B 0F88F7000000                js read_failed_handler                  ; если rax < 0 (ошибка), прыжок к обработчику ошибки чтения
    67                                  
    68 00000051 4889C3                      mov rbx, rax                            ; сохраняем длину введённой строки в rbx
    69                                  
    70 00000054 4889DF                      mov rdi, rbx                            ; передаем длину в rdi для функции reverse_string
    71 00000057 BE0A000000                  mov rsi, NEWLINE                        ; передаем завершающий байт
    72 0000005C E855000000                  call reverse_string                     ; вызываем функцию разворота строки
    73 00000061 4889FB                      mov rbx, rdi                            ; обновляем длину строки после разворота (rdi возвращает длину)
    74                                  
    75                                      ; ---- Вывести подсказку к результату ----
    76 00000064 B801000000                  mov rax, WRITE
    77 00000069 BF01000000                  mov rdi, STDOUT
    78 0000006E 488D35(14000000)            lea rsi, [rel msg_result]
    79 00000075 BA0B000000                  mov rdx, len_msg_result
    80 0000007A 0F05                        syscall
    81                                  
    82 0000007C 4885C0                      test rax, rax                           ; проверка возвращенного значения rax (кол-во записанных байт)
    83 0000007F 0F8883000000                js write_failed_handler                 ; если rax < 0 (ошибка), прыжок к обработчику ошибки записи
    84                                  
    85 00000085 4839D0                      cmp rax, rdx                            ; проверяем, совпадает ли количество записанных байт с ожидаемым
    86 00000088 0F859A000000                jne write_byte_number_mismatch_handler  ; если нет, прыжок к обработчику несоответствия байт
    87                                  
    88                                      ; Запись развернутой строки на стандартный вывод
    89 0000008E B801000000                  mov rax, WRITE                          ; системный вызов write
    90 00000093 4889DA                      mov rdx, rbx                            ; количество байт для записи
    91 00000096 BF01000000                  mov rdi, STDOUT                         ; дескриптор stdout
    92 0000009B 48BE-                       mov rsi, reverse_str                    ; адрес буфера с развернутой строкой
    92 0000009D [6400000000000000] 
    93 000000A5 0F05                        syscall                                 ; выполняем системный вызов write
    94                                  
    95 000000A7 4885C0                      test rax, rax                           ; проверка возвращенного значения rax (кол-во записанных байт)
    96 000000AA 785C                        js write_failed_handler                 ; если rax < 0 (ошибка), прыжок к обработчику ошибки записи
    97                                  
    98 000000AC 4839D8                      cmp rax, rbx                            ; проверяем, совпадает ли количество записанных байт с ожидаемым
    99 000000AF 7577                        jne write_byte_number_mismatch_handler  ; если нет, прыжок к обработчику несоответствия байт
   100                                  
   101 000000B1 E9B2000000                  jmp exit                                ; завершение программы
   102                                  
   103                                  ; --------------------------------------------------
   104                                  ; Функция reverse_string:
   105                                  ; rdi = длина строки
   106                                  ; rsi = завершающий байт
   107                                  ; Использует input_str и reverse_str из .bss
   108                                  ; --------------------------------------------------
   109                                  reverse_string:
   110 000000B6 55                          push rbp                                ; сохраняем базовый указатель прошлого стекового фрейма
   111 000000B7 4889E5                      mov rbp, rsp                            ; устанавливаем новый базовый указатель
   112                                  
   113 000000BA 4885FF                      test rdi, rdi                           ; rdi & rdi, 0 - пустая строка
   114 000000BD 741A                        jz .end_if                              ; если строка пустая, то отступ делать не надо
   115                                  
   116 000000BF 48FFCF                      dec rdi                                 ; делаем отступ к последнему индексу строки
   117 000000C2 80BF[00000000]0A            cmp byte [input_str + rdi], NEWLINE     ; проверяем послендний индекс на символ '\n'
   118 000000C9 740B                        je .end_byte_present                    
   119 000000CB 80BF[00000000]00            cmp byte [input_str + rdi], NULL_CHAR   ; проверяем послендний индекс на символ '\0'
   120 000000D2 7402                        jz .end_byte_present
   121                                  
   122 000000D4 EB03                        jmp .end_if                             ; у строки нет заканчивающего байта, отступ делать не надо
   123                                  
   124                                      .end_byte_present:
   125 000000D6 48FFCF                      dec rdi                                 ; отступ для пропуска '\0' или '\n' в конце строки
   126                                  
   127                                      .end_if:
   128                                  
   129 000000D9 4D31D2                      xor r10, r10                            ; r10 = 0, индекс для записи в reverse_str
   130                                  
   131                                  .loop:                                      ; локальная метка начала цикла
   132 000000DC 4939FA                      cmp r10, rdi                            ; проверяем, достигли ли конца строки
   133 000000DF 7F18                        jg .done                                ; jump if greater or equal, если r10 > последнего индекса, завершить цикл
   134                                  
   135 000000E1 4889F8                      mov rax, rdi                            ; rax = последний индекс строки
   136 000000E4 4C29D0                      sub rax, r10                            ; rax = последний индекс, смещенный на r10 влево
   137 000000E7 8A98[00000000]              mov bl, [input_str + rax]               ; читаем символ с конца input_str
   138 000000ED 41889A[64000000]            mov byte [reverse_str + r10], bl        ; записываем символ в reverse_str
   139                                  
   140 000000F4 49FFC2                      inc r10                                 ; увеличиваем индекс назначения
   141 000000F7 EBE3                        jmp .loop                               ; повторяем цикл
   142                                  
   143                                  .done:                                      ; локальная метка окончания цикла
   144 000000F9 48FFC7                      inc rdi                                 ; увеличиваем индекс на 1
   145 000000FC 4889B7[64000000]            mov [reverse_str + rdi], rsi            ; добавляем завершающий байт в конец reverse_str
   146                                  
   147 00000103 48FFC7                      inc rdi                                 ; увеличиваем индекс на 1 для возврата длины строки
   148                                  
   149 00000106 5D                          pop rbp                                 ; восстанавливаем базовый указатель стека
   150 00000107 C3                          ret                                     ; возвращаем управление вызывающей функции
   151                                  
   152                                  ; ----------------------------
   153                                  ; Обработчики ошибок
   154                                  ; ----------------------------
   155                                  write_failed_handler:                       ; метка обработчика ошибки write()
   156 00000108 4989C5                      mov r13, rax                            ; сохраняем код ошибки
   157                                  
   158 0000010B B801000000                  mov rax, WRITE                          ; системный вызов write
   159 00000110 BF02000000                  mov rdi, STDERR                         ; дескриптор потока ошибок
   160 00000115 48BE-                       mov rsi, write_failed_msg               ; адрес сообщения
   160 00000117 [1F00000000000000] 
   161 0000011F BA17000000                  mov rdx, write_failed_msg_len           ; длина сообщения
   162 00000124 0F05                        syscall                                 ; выполняем системный вызов write
   163                                  
   164 00000126 EB40                        jmp exit                                ; завершение программы
   165                                  
   166                                  write_byte_number_mismatch_handler:         ; метка обработчика несоответствия байт
   167 00000128 4989C5                      mov r13, rax                            ; сохраняем код ошибки
   168                                  
   169 0000012B B801000000                  mov rax, WRITE                              ; системный вызов write
   170 00000130 BF02000000                  mov rdi, STDERR                             ; дескриптор потока ошибок
   171 00000135 48BE-                       mov rsi, write_byte_number_mismatch_msg     ; адрес сообщения
   171 00000137 [3600000000000000] 
   172 0000013F BA2C000000                  mov rdx, write_byte_number_mismatch_msg_len ; длина сообщения
   173 00000144 0F05                        syscall                                     ; выполняем системный вызов write
   174                                  
   175 00000146 EB20                        jmp exit                                ; завершение программы
   176                                  
   177                                  read_failed_handler:                        ; метка обработчика ошибки read()
   178 00000148 4989C5                      mov r13, rax                            ; сохраняем код ошибки
   179                                  
   180 0000014B B801000000                  mov rax, WRITE                          ; системный вызов write
   181 00000150 BF02000000                  mov rdi, STDERR                         ; дескриптор потока ошибок
   182 00000155 48BE-                       mov rsi, read_failed_msg                ; адрес сообщения
   182 00000157 [6200000000000000] 
   183 0000015F BA16000000                  mov rdx, read_failed_msg_len            ; длина сообщения
   184 00000164 0F05                        syscall                                 ; выполняем системный вызов write
   185                                  
   186 00000166 EB00                        jmp exit                                ; завершение программы
   187                                  
   188                                  exit:                                       ; метка выхода из программы
   189 00000168 4C89EF                      mov rdi, r13                            ; код завершения программы
   190 0000016B B83C000000                  mov rax, EXIT                           ; системный вызов exit
   191 00000170 0F05                        syscall                                 ; выполняем системный вызов
