     1                                  ; Задача №2.1. Разворот входящей строки
     2                                  
     3                                  ; Объявление констант
     4                                  %define MAX_INPUT_STR_SIZE 100  ; максимальный размер входной строки 100 символов
     5                                  
     6                                  %define EXIT 60                 ; 60 - номер системного вызова exit
     7                                  %define READ 0                  ; 0 - номер системного вызова read
     8                                  %define WRITE 1                 ; 1 - номер системного вызова write
     9                                  
    10                                  %define STDIN 0                 ; 0 - дескриптор стандартного ввода
    11                                  %define STDOUT 1                ; 1 - дескриптор стандартного вывода
    12                                  %define STDERR 2                ; 2 - дескриптор стандартного потока ошибок
    13                                  
    14                                  %define NULL_CHAR 0             ; код символа '\0'
    15                                  %define NEWLINE 0x0A            ; код символа перевода строки '\n'
    16                                  
    17                                  global _start   ; делаем точку входа _start видимой для линковщика
    18                                  
    19                                  section .bss    ; Секция BSS — для глобальных неинициализированных переменных
    20 00000000 <res 64h>                   input_str resb MAX_INPUT_STR_SIZE               ; буфер для ввода строки
    21 00000064 <res 64h>                   reverse_str resb MAX_INPUT_STR_SIZE             ; буфер для развернутой строки
    22                                  
    23                                  section .data                                       ; секция данных
    24                                      ; Подсказки в консоли
    25 00000000 456E74657220796F75-         prompt1 db "Enter your string: ", NULL_CHAR     ; подсказка для ввода строки
    25 00000009 7220737472696E673A-
    25 00000012 2000               
    26                                      len_prompt1 equ $-prompt1                       ; длина подсказки 1
    27                                  
    28 00000014 52657665727365643A-         msg_result db "Reversed: ", NULL_CHAR           ; подсказка для вывода перевернутой строки
    28 0000001D 2000               
    29                                      len_msg_result equ $-msg_result                 ; длина подсказки результата
    30                                  
    31                                      ; Сообщения об ошибках
    32 0000001F 4572726F723A207772-         write_failed_msg db "Error: write() failed", NEWLINE, NULL_CHAR                                     ; сообщение об ошибке write
    32 00000028 697465282920666169-
    32 00000031 6C65640A00         
    33                                      write_failed_msg_len equ $ - write_failed_msg                                                       ; длина сообщения
    34 00000036 4572726F723A207772-         write_byte_number_mismatch_msg db "Error: write() write wrong number of bytes", NEWLINE, NULL_CHAR  ; ошибка записи неправильного количества байт
    34 0000003F 697465282920777269-
    34 00000048 74652077726F6E6720-
    34 00000051 6E756D626572206F66-
    34 0000005A 2062797465730A00   
    35                                      write_byte_number_mismatch_msg_len equ $ - write_byte_number_mismatch_msg                           ; длина сообщения
    36                                  
    37 00000062 4572726F723A207265-         read_failed_msg db "Error: read() failed", NEWLINE, NULL_CHAR                                       ; сообщение об ошибке read
    37 0000006B 61642829206661696C-
    37 00000074 65640A00           
    38                                      read_failed_msg_len equ $ - read_failed_msg                                                         ; длина сообщения
    39                                  
    40                                  section .text
    41                                  
    42                                  _start:     ; точка входа программы
    43 00000000 4D31ED                      xor r13, r13                            ; устанавливаем код завершения r13 = 0 (успех)
    44                                  
    45                                      ; ---- Промпт 1 ----
    46 00000003 B801000000                  mov rax, WRITE
    47 00000008 BF01000000                  mov rdi, STDOUT
    48 0000000D 488D35(00000000)            lea rsi, [rel prompt1]
    49 00000014 BA14000000                  mov rdx, len_prompt1
    50 00000019 0F05                        syscall
    51                                  
    52 0000001B 4885C0                      test rax, rax                           ; проверка возвращенного значения rax (кол-во записанных байт)
    53 0000001E 0F88D9000000                js write_failed_handler                 ; если rax < 0 (ошибка), прыжок к обработчику ошибки записи
    54                                  
    55 00000024 4839D0                      cmp rax, rdx                            ; проверяем, совпадает ли количество записанных байт с ожидаемым
    56 00000027 0F85ED000000                jne write_byte_number_mismatch_handler  ; если нет, прыжок к обработчику несоответствия байт
    57                                  
    58                                      ; Чтение строки с клавиатуры
    59 0000002D B800000000                  mov rax, READ                           ; номер системного вызова read
    60 00000032 BF00000000                  mov rdi, STDIN                          ; дескриптор входного потока (stdin)
    61 00000037 488D35(00000000)            lea rsi, [rel input_str]                ; адрес буфера для сохранения введенной строки
    62 0000003E BA64000000                  mov rdx, MAX_INPUT_STR_SIZE             ; количество байтов для чтения
    63 00000043 0F05                        syscall                                 ; выполнить системный вызов read
    64                                  
    65 00000045 4885C0                      test rax, rax                           ; проверяем возвращенное значение rax (кол-во прочитанных байт)
    66 00000048 0F88E9000000                js read_failed_handler                  ; если rax < 0 (ошибка), прыжок к обработчику ошибки чтения
    67                                  
    68 0000004E 4889C3                      mov rbx, rax                            ; сохраняем длину введённой строки в rbx
    69                                  
    70 00000051 4889DF                      mov rdi, rbx                            ; передаем длину в rdi для функции reverse_string
    71 00000054 BE0A000000                  mov rsi, NEWLINE                        ; передаем завершающий байт
    72 00000059 488D15(00000000)            lea rdx, [rel input_str]
    73 00000060 488D0D(64000000)            lea rcx, [rel reverse_str]
    74 00000067 E84E000000                  call reverse_string                     ; вызываем функцию разворота строки
    75 0000006C 4889FB                      mov rbx, rdi                            ; обновляем длину строки после разворота (rdi возвращает длину)
    76                                  
    77                                      ; ---- Вывести подсказку к результату ----
    78 0000006F B801000000                  mov rax, WRITE
    79 00000074 BF01000000                  mov rdi, STDOUT
    80 00000079 488D35(14000000)            lea rsi, [rel msg_result]
    81 00000080 BA0B000000                  mov rdx, len_msg_result
    82 00000085 0F05                        syscall
    83                                  
    84 00000087 4885C0                      test rax, rax                           ; проверка возвращенного значения rax (кол-во записанных байт)
    85 0000008A 7871                        js write_failed_handler                 ; если rax < 0 (ошибка), прыжок к обработчику ошибки записи
    86                                  
    87 0000008C 4839D0                      cmp rax, rdx                            ; проверяем, совпадает ли количество записанных байт с ожидаемым
    88 0000008F 0F8585000000                jne write_byte_number_mismatch_handler  ; если нет, прыжок к обработчику несоответствия байт
    89                                  
    90                                      ; Запись развернутой строки на стандартный вывод
    91 00000095 B801000000                  mov rax, WRITE                          ; системный вызов write
    92 0000009A 4889DA                      mov rdx, rbx                            ; количество байт для записи
    93 0000009D BF01000000                  mov rdi, STDOUT                         ; дескриптор stdout
    94 000000A2 488D35(64000000)            lea rsi, [rel reverse_str]              ; адрес буфера с развернутой строкой
    95 000000A9 0F05                        syscall                                 ; выполняем системный вызов write
    96                                  
    97 000000AB 4885C0                      test rax, rax                           ; проверка возвращенного значения rax (кол-во записанных байт)
    98 000000AE 784D                        js write_failed_handler                 ; если rax < 0 (ошибка), прыжок к обработчику ошибки записи
    99                                  
   100 000000B0 4839D8                      cmp rax, rbx                            ; проверяем, совпадает ли количество записанных байт с ожидаемым
   101 000000B3 7565                        jne write_byte_number_mismatch_handler  ; если нет, прыжок к обработчику несоответствия байт
   102                                  
   103 000000B5 E99A000000                  jmp exit                                ; завершение программы
   104                                  
   105                                  ; --------------------------------------------------
   106                                  ; Функция reverse_string:
   107                                  ; rdi = длина строки
   108                                  ; rsi = завершающий байт
   109                                  ; rdx = адрес буфера входящей строки
   110                                  ; rcx = адрес буфера перевернутой строки
   111                                  ; Использует input_str и reverse_str из .bss
   112                                  ; --------------------------------------------------
   113                                  reverse_string:
   114 000000BA 55                          push rbp                                ; сохраняем базовый указатель прошлого стекового фрейма
   115 000000BB 4889E5                      mov rbp, rsp                            ; устанавливаем новый базовый указатель
   116                                  
   117 000000BE 4885FF                      test rdi, rdi                           ; rdi & rdi, 0 - пустая строка
   118 000000C1 7414                        jz .end_if                              ; если строка пустая, то отступ делать не надо
   119                                  
   120 000000C3 48FFCF                      dec rdi                                 ; делаем отступ к последнему индексу строки
   121 000000C6 803C3A0A                    cmp byte [rdx + rdi], NEWLINE     ; проверяем послендний индекс на символ '\n'
   122 000000CA 7408                        je .end_byte_present                    
   123 000000CC 803C3A00                    cmp byte [rdx + rdi], NULL_CHAR   ; проверяем послендний индекс на символ '\0'
   124 000000D0 7402                        jz .end_byte_present
   125                                  
   126 000000D2 EB03                        jmp .end_if                             ; у строки нет заканчивающего байта, отступ делать не надо
   127                                  
   128                                      .end_byte_present:
   129 000000D4 48FFCF                       dec rdi                                 ; отступ для пропуска '\0' или '\n' в конце строки
   130                                  
   131                                      .end_if:
   132                                  
   133 000000D7 4D31D2                      xor r10, r10                            ; r10 = 0, индекс для записи в reverse_str
   134                                  
   135                                  .loop:                                      ; локальная метка начала цикла
   136 000000DA 4939FA                      cmp r10, rdi                            ; проверяем, достигли ли конца строки
   137 000000DD 7F12                        jg .done                                ; jump if greater or equal, если r10 > последнего индекса, завершить цикл
   138                                  
   139 000000DF 4889F8                      mov rax, rdi                            ; rax = последний индекс строки
   140 000000E2 4C29D0                      sub rax, r10                            ; rax = последний индекс, смещенный на r10 влево
   141 000000E5 8A1C02                      mov bl, [rdx + rax]               ; читаем символ с конца input_str
   142 000000E8 42881C11                    mov byte [rcx + r10], bl        ; записываем символ в reverse_str
   143                                  
   144 000000EC 49FFC2                      inc r10                                 ; увеличиваем индекс назначения
   145 000000EF EBE9                        jmp .loop                               ; повторяем цикл
   146                                  
   147                                  .done:                                      ; локальная метка окончания цикла
   148 000000F1 48FFC7                      inc rdi                                 ; увеличиваем индекс на 1
   149 000000F4 48893439                    mov [rcx + rdi], rsi            ; добавляем завершающий байт в конец reverse_str
   150                                  
   151 000000F8 48FFC7                      inc rdi                                 ; увеличиваем индекс на 1 для возврата длины строки
   152                                  
   153 000000FB 5D                          pop rbp                                 ; восстанавливаем базовый указатель стека
   154 000000FC C3                          ret                                     ; возвращаем управление вызывающей функции
   155                                  
   156                                  ; ----------------------------
   157                                  ; Обработчики ошибок
   158                                  ; ----------------------------
   159                                  write_failed_handler:                       ; метка обработчика ошибки write()
   160 000000FD 4989C5                      mov r13, rax                            ; сохраняем код ошибки
   161                                  
   162 00000100 B801000000                  mov rax, WRITE                          ; системный вызов write
   163 00000105 BF02000000                  mov rdi, STDERR                         ; дескриптор потока ошибок
   164 0000010A 488D35(1F000000)            lea rsi, [rel write_failed_msg]               ; адрес сообщения
   165 00000111 BA17000000                  mov rdx, write_failed_msg_len           ; длина сообщения
   166 00000116 0F05                        syscall                                 ; выполняем системный вызов write
   167                                  
   168 00000118 EB3A                        jmp exit                                ; завершение программы
   169                                  
   170                                  write_byte_number_mismatch_handler:         ; метка обработчика несоответствия байт
   171 0000011A 4989C5                      mov r13, rax                            ; сохраняем код ошибки
   172                                  
   173 0000011D B801000000                  mov rax, WRITE                                      ; системный вызов write
   174 00000122 BF02000000                  mov rdi, STDERR                                     ; дескриптор потока ошибок
   175 00000127 488D35(36000000)            lea rsi, [rel write_byte_number_mismatch_msg]       ; адрес сообщения
   176 0000012E BA2C000000                  mov rdx, write_byte_number_mismatch_msg_len         ; длина сообщения
   177 00000133 0F05                        syscall                                             ; выполняем системный вызов write
   178                                  
   179 00000135 EB1D                        jmp exit                                ; завершение программы
   180                                  
   181                                  read_failed_handler:                        ; метка обработчика ошибки read()
   182 00000137 4989C5                      mov r13, rax                            ; сохраняем код ошибки
   183                                  
   184 0000013A B801000000                  mov rax, WRITE                          ; системный вызов write
   185 0000013F BF02000000                  mov rdi, STDERR                         ; дескриптор потока ошибок
   186 00000144 488D35(62000000)            lea rsi, [rel read_failed_msg]          ; адрес сообщения
   187 0000014B BA16000000                  mov rdx, read_failed_msg_len            ; длина сообщения
   188 00000150 0F05                        syscall                                 ; выполняем системный вызов write
   189                                  
   190 00000152 EB00                        jmp exit                                ; завершение программы
   191                                  
   192                                  exit:                                       ; метка выхода из программы
   193 00000154 4C89EF                      mov rdi, r13                            ; код завершения программы
   194 00000157 B83C000000                  mov rax, EXIT                           ; системный вызов exit
   195 0000015C 0F05                        syscall                                 ; выполняем системный вызов
