     1                                  ; Задача №2.1. Разворот входящей строки
     2                                  
     3                                  ; Объявление констант
     4                                  %define MAX_INPUT_STR_SIZE 100  ; максимальный размер входной строки 100 символов
     5                                  
     6                                  %define EXIT 60     ; 60 - номер системного вызова exit
     7                                  %define READ 0      ; 0 - номер системного вызова read
     8                                  %define WRITE 1     ; 1 - номер системного вызова write
     9                                  
    10                                  %define STDIN 0     ; 0 - дескриптор стандартного ввода
    11                                  %define STDOUT 1    ; 1 - дескриптор стандартного вывода
    12                                  %define STDERR 2    ; 2 - дескриптор стандартного потока ошибок
    13                                  
    14                                  %define NULL_CHAR 0     ; код символа '\0'
    15                                  %define NEWLINE 0x0A         ; код символа перевода строки '\n'
    16                                  
    17                                  global _start   ; делаем точку входа _start видимой для линковщика
    18                                  
    19                                  section .bss    ; Секция BSS — для глобальных неинициализированных переменных
    20 00000000 <res 64h>                   input_str resb MAX_INPUT_STR_SIZE    ; буфер для ввода строки
    21 00000064 <res 64h>                   reverse_str resb MAX_INPUT_STR_SIZE  ; буфер для развернутой строки
    22                                  
    23                                  section .data   ; секция данных
    24                                      ; Сообщения об ошибках
    25 00000000 4572726F723A207772-         write_failed_msg db "Error: write() failed", 10, 0       ; сообщение об ошибке write
    25 00000009 697465282920666169-
    25 00000012 6C65640A00         
    26                                      write_failed_msg_len equ $ - write_failed_msg            ; длина сообщения
    27 00000017 4572726F723A207772-         write_byte_number_mismatch_msg db "Error: write() write wrong number of bytes", 10, 0 ; ошибка записи неправильного количества байт
    27 00000020 697465282920777269-
    27 00000029 74652077726F6E6720-
    27 00000032 6E756D626572206F66-
    27 0000003B 2062797465730A00   
    28                                      write_byte_number_mismatch_msg_len equ $ - write_byte_number_mismatch_msg           ; длина сообщения
    29                                  
    30 00000043 4572726F723A207265-         read_failed_msg db "Error: read() failed", 10, 0        ; сообщение об ошибке read
    30 0000004C 61642829206661696C-
    30 00000055 65640A00           
    31                                      read_failed_msg_len equ $ - read_failed_msg             ; длина сообщения
    32                                  
    33                                  section .text
    34                                  
    35                                  _start:     ; точка входа программы
    36 00000000 4D31ED                      xor r13, r13                      ; устанавливаем код завершения r13 = 0 (успех)
    37                                  
    38                                      ; ----------------------------
    39                                      ; Чтение строки с клавиатуры
    40 00000003 B800000000                  mov rax, READ            ; номер системного вызова read
    41 00000008 BF00000000                  mov rdi, STDIN           ; дескриптор входного потока (stdin)
    42 0000000D 48BE-                       mov rsi, input_str       ; адрес буфера для сохранения введенной строки
    42 0000000F [0000000000000000] 
    43 00000017 BA64000000                  mov rdx, MAX_INPUT_STR_SIZE  ; количество байтов для чтения
    44 0000001C 0F05                        syscall                  ; выполнить системный вызов read
    45                                  
    46 0000001E 4885C0                      test rax, rax            ; проверяем возвращенное значение rax (кол-во прочитанных байт)
    47 00000021 0F88C4000000                js read_failed_handler   ; если rax < 0 (ошибка), прыжок к обработчику ошибки чтения
    48                                  
    49 00000027 4889C3                      mov rbx, rax             ; сохраняем длину введённой строки в rbx
    50                                  
    51 0000002A 48FFCB                      dec rbx                  ; уменьшаем индекс на 1 для проверки последнего символа
    52 0000002D 80BB[00000000]0A            cmp byte [input_str + rbx], NEWLINE   ; проверяем, является ли последний символ переносом строки
    53 00000034 7507                        jne .no_newline          ; если нет, перейти к локальной метке .no_newline
    54 00000036 C683[00000000]00            mov byte [input_str + rbx], NULL_CHAR ; заменяем '\n' на нуль-терминатор
    55                                      .no_newline:                  ; локальная метка для продолжения, если перенос строки отсутствует
    56                                  
    57 0000003D 4889DF                      mov rdi, rbx             ; передаем длину строки в rdi для функции reverse_string
    58 00000040 E82B000000                  call reverse_string       ; вызываем функцию разворота строки
    59 00000045 4889FB                      mov rbx, rdi             ; обновляем длину строки после разворота (rdi возвращает длину)
    60                                  
    61                                      ; ----------------------------
    62                                      ; Запись развернутой строки на стандартный вывод
    63 00000048 B801000000                  mov rax, WRITE           ; системный вызов write
    64 0000004D 4889DA                      mov rdx, rbx             ; количество байт для записи
    65 00000050 BF01000000                  mov rdi, STDOUT          ; дескриптор stdout
    66 00000055 48BE-                       mov rsi, reverse_str     ; адрес буфера с развернутой строкой
    66 00000057 [6400000000000000] 
    67 0000005F 0F05                        syscall                  ; выполняем системный вызов write
    68                                  
    69 00000061 4885C0                      test rax, rax            ; проверка возвращенного значения rax (кол-во записанных байт)
    70 00000064 7845                        js write_failed_handler   ; если rax < 0 (ошибка), прыжок к обработчику ошибки записи
    71                                  
    72 00000066 4839D8                      cmp rax, rbx             ; проверяем, совпадает ли количество записанных байт с ожидаемым
    73 00000069 7560                        jne write_byte_number_mismatch_handler ; если нет, прыжок к обработчику несоответствия байт
    74                                  
    75 0000006B E99B000000                  jmp exit                 ; завершение программы
    76                                  
    77                                  ; --------------------------------------------------
    78                                  ; Функция reverse_string:
    79                                  ; rdi = длина строки
    80                                  ; Использует input_str и reverse_str из .bss
    81                                  ; --------------------------------------------------
    82                                  reverse_string:
    83 00000070 55                          push rbp                 ; сохраняем базовый указатель прошлого стекового фрейма
    84 00000071 4889E5                      mov rbp, rsp             ; устанавливаем новый базовый указатель
    85 00000074 4D31D2                      xor r10, r10             ; r10 = 0, индекс для записи в reverse_str
    86                                  
    87                                  .loop:                       ; локальная метка начала цикла
    88 00000077 4939FA                      cmp r10, rdi             ; проверяем, достигли ли конца строки
    89 0000007A 7D1B                        jge .done                ; если r10 >= длины, завершить цикл
    90                                  
    91 0000007C 4889F8                      mov rax, rdi             ; rax = длина строки
    92 0000007F 4C29D0                      sub rax, r10             ; rax = индекс символа с конца
    93 00000082 48FFC8                      dec rax                  ; корректировка индекса (0-based)
    94 00000085 8A98[00000000]              mov bl, [input_str + rax]    ; читаем символ с конца input_str
    95 0000008B 41889A[64000000]            mov byte [reverse_str + r10], bl   ; записываем символ в reverse_str
    96                                  
    97 00000092 49FFC2                      inc r10                  ; увеличиваем индекс назначения
    98 00000095 EBE0                        jmp .loop                ; повторяем цикл
    99                                  
   100                                  .done:                        ; локальная метка окончания цикла
   101 00000097 B30A                        mov bl, NEWLINE          ; символ новой строки
   102 00000099 889F[64000000]              mov [reverse_str + rdi], bl   ; добавляем перенос строки в конец reverse_str
   103 0000009F 48FFC7                      inc rdi                  ; увеличиваем длину строки на 1 (включаем newline)
   104 000000A2 C687[64000000]00            mov byte [reverse_str + rdi], NULL_CHAR ; добавляем нуль-терминатор
   105 000000A9 5D                          pop rbp                  ; восстанавливаем базовый указатель стека
   106 000000AA C3                          ret                       ; возвращаем управление вызывающей функции
   107                                  
   108                                  ; ----------------------------
   109                                  ; Обработчики ошибок
   110                                  ; ----------------------------
   111                                  write_failed_handler:          ; метка обработчика ошибки write()
   112 000000AB 4989C5                      mov r13, rax             ; сохраняем код ошибки
   113                                  
   114 000000AE B801000000                  mov rax, WRITE           ; системный вызов write
   115 000000B3 BF02000000                  mov rdi, STDERR          ; дескриптор потока ошибок
   116 000000B8 48BE-                       mov rsi, write_failed_msg    ; адрес сообщения
   116 000000BA [0000000000000000] 
   117 000000C2 BA17000000                  mov rdx, write_failed_msg_len ; длина сообщения
   118 000000C7 0F05                        syscall                  ; выполняем системный вызов write
   119                                  
   120 000000C9 EB40                        jmp exit                 ; завершение программы
   121                                  
   122                                  write_byte_number_mismatch_handler: ; метка обработчика несоответствия байт
   123 000000CB 4989C5                      mov r13, rax             ; сохраняем код ошибки
   124                                  
   125 000000CE B801000000                  mov rax, WRITE           ; системный вызов write
   126 000000D3 BF02000000                  mov rdi, STDERR          ; дескриптор потока ошибок
   127 000000D8 48BE-                       mov rsi, write_byte_number_mismatch_msg ; адрес сообщения
   127 000000DA [1700000000000000] 
   128 000000E2 BA2C000000                  mov rdx, write_byte_number_mismatch_msg_len ; длина сообщения
   129 000000E7 0F05                        syscall                  ; выполняем системный вызов write
   130                                  
   131 000000E9 EB20                        jmp exit                 ; завершение программы
   132                                  
   133                                  read_failed_handler:           ; метка обработчика ошибки read()
   134 000000EB 4989C5                      mov r13, rax             ; сохраняем код ошибки
   135                                  
   136 000000EE B801000000                  mov rax, WRITE           ; системный вызов write
   137 000000F3 BF02000000                  mov rdi, STDERR          ; дескриптор потока ошибок
   138 000000F8 48BE-                       mov rsi, read_failed_msg ; адрес сообщения
   138 000000FA [4300000000000000] 
   139 00000102 BA16000000                  mov rdx, read_failed_msg_len ; длина сообщения
   140 00000107 0F05                        syscall                  ; выполняем системный вызов write
   141                                  
   142 00000109 EB00                        jmp exit                 ; завершение программы
   143                                  
   144                                  exit:                       ; метка выхода из программы
   145 0000010B 4C89EF                      mov rdi, r13             ; код завершения программы
   146 0000010E B83C000000                  mov rax, EXIT            ; системный вызов exit
   147 00000113 0F05                        syscall                  ; выполняем системный вызов
